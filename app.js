const MM_TO_PX = 3;
const DECIMAL_PRECISION = 1;
const DECIMAL_FACTOR = 10 ** DECIMAL_PRECISION;
const LID_FIT_EXTRA = 0.3;

// Preset data - will be loaded from presets.json
let DIMENSION_PRESETS = [];
let COLOR_PRESETS = [];

const LAYOUT_CONSTANTS = {
  margin: 20,
  panelGHeight: 10,
  sideFlapWidth: 10,
};

const STYLES = {
  cut: "stroke:#000000; stroke-width:0.35; fill:none;",
  fold: {
    mountain: "stroke:#d1d5db; stroke-width:0.25; fill:none;",
    valley:
      "stroke:#d1d5db; stroke-width:0.25; stroke-dasharray: 1 4; fill:none;",
  },
  text: {
    primary:
      "fill:#111827; font-size: 4px; font-family: sans-serif; text-anchor: middle; alignment-baseline: middle;",
    muted:
      "fill:rgba(17, 24, 39, 0.6); font-size: 4px; font-family: sans-serif; text-anchor: middle; alignment-baseline: middle;",
  },
};

const FOOTER_TEXT = "webmachines.nl/ultimatepaperboxes";
const FOOTER_TARGET_WIDTH_RATIO = 0.5;
const FOOTER_GROUP_STYLE = "fill:#d1d5db; opacity:0.65;";
const FOOTER_VECTOR_WIDTH = 2108;
const FOOTER_VECTOR_HEIGHT = 114;
const FOOTER_VECTOR_MARKUP = String.raw`
<g transform="matrix(1,0,0,1,-229.875513,-1025.075157)">
  <g transform="matrix(2.257439,0,0,2.257439,-40.206051,-1134.635205)">
    <g transform="matrix(50,0,0,50,118.921138,995.893937)">
      <path d="M0.163,-0L0.014,-0.504L0.162,-0.504L0.256,-0.1L0.228,-0.101L0.336,-0.504L0.501,-0.504L0.609,-0.101L0.581,-0.1L0.674,-0.504L0.822,-0.504L0.674,-0L0.518,-0L0.403,-0.413L0.434,-0.413L0.318,-0L0.163,-0Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,159.921138,995.893937)">
      <path d="M0.313,0.012C0.261,0.012 0.215,0.001 0.176,-0.021C0.136,-0.042 0.106,-0.073 0.084,-0.111C0.061,-0.15 0.05,-0.195 0.05,-0.246C0.05,-0.298 0.061,-0.344 0.083,-0.385C0.105,-0.425 0.135,-0.457 0.175,-0.481C0.214,-0.504 0.26,-0.515 0.312,-0.515C0.363,-0.515 0.407,-0.505 0.445,-0.483C0.483,-0.461 0.513,-0.431 0.535,-0.393C0.556,-0.356 0.567,-0.312 0.567,-0.263C0.567,-0.256 0.567,-0.249 0.566,-0.24C0.566,-0.232 0.565,-0.223 0.564,-0.215L0.157,-0.215L0.157,-0.302L0.414,-0.302C0.413,-0.33 0.403,-0.353 0.384,-0.37C0.365,-0.387 0.341,-0.395 0.313,-0.395C0.292,-0.395 0.273,-0.39 0.255,-0.38C0.237,-0.37 0.224,-0.355 0.213,-0.335C0.203,-0.315 0.198,-0.29 0.198,-0.259L0.198,-0.229C0.198,-0.206 0.203,-0.185 0.212,-0.167C0.221,-0.149 0.234,-0.135 0.251,-0.125C0.268,-0.115 0.288,-0.11 0.311,-0.11C0.333,-0.11 0.351,-0.114 0.366,-0.123C0.38,-0.132 0.391,-0.144 0.399,-0.158L0.552,-0.158C0.543,-0.126 0.526,-0.097 0.504,-0.072C0.481,-0.046 0.454,-0.026 0.421,-0.011C0.389,0.004 0.352,0.012 0.313,0.012Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,190.521138,995.893937)">
      <path d="M0.372,0.012C0.347,0.012 0.325,0.009 0.305,0.003C0.286,-0.003 0.268,-0.012 0.253,-0.022C0.238,-0.033 0.226,-0.046 0.215,-0.06L0.198,-0L0.065,-0L0.065,-0.72L0.215,-0.72L0.215,-0.438C0.231,-0.461 0.251,-0.479 0.277,-0.494C0.302,-0.508 0.334,-0.515 0.371,-0.515C0.417,-0.515 0.458,-0.504 0.495,-0.481C0.531,-0.458 0.559,-0.427 0.581,-0.387C0.602,-0.348 0.613,-0.302 0.613,-0.251C0.613,-0.201 0.602,-0.156 0.581,-0.116C0.56,-0.076 0.531,-0.045 0.495,-0.022C0.459,0.001 0.418,0.012 0.372,0.012ZM0.335,-0.119C0.359,-0.119 0.381,-0.124 0.399,-0.136C0.418,-0.147 0.433,-0.163 0.444,-0.182C0.454,-0.202 0.46,-0.225 0.46,-0.251C0.46,-0.277 0.454,-0.3 0.444,-0.32C0.433,-0.34 0.418,-0.356 0.399,-0.368C0.381,-0.379 0.359,-0.385 0.335,-0.385C0.31,-0.385 0.289,-0.379 0.27,-0.368C0.251,-0.356 0.236,-0.34 0.225,-0.321C0.215,-0.301 0.209,-0.278 0.209,-0.251C0.209,-0.226 0.215,-0.203 0.225,-0.183C0.236,-0.163 0.251,-0.147 0.27,-0.136C0.289,-0.124 0.31,-0.119 0.335,-0.119Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,223.671138,995.893937)">
      <path d="M0.065,-0L0.065,-0.504L0.196,-0.504L0.209,-0.439C0.225,-0.462 0.246,-0.481 0.272,-0.495C0.299,-0.509 0.329,-0.515 0.364,-0.515C0.388,-0.515 0.411,-0.512 0.431,-0.506C0.451,-0.5 0.468,-0.491 0.484,-0.478C0.499,-0.466 0.512,-0.451 0.522,-0.432C0.541,-0.458 0.566,-0.478 0.596,-0.493C0.626,-0.508 0.659,-0.515 0.694,-0.515C0.739,-0.515 0.777,-0.507 0.806,-0.489C0.836,-0.471 0.858,-0.445 0.873,-0.411C0.888,-0.377 0.895,-0.336 0.895,-0.287L0.895,-0L0.746,-0L0.746,-0.274C0.746,-0.31 0.739,-0.339 0.724,-0.359C0.71,-0.38 0.687,-0.39 0.656,-0.39C0.636,-0.39 0.618,-0.385 0.603,-0.375C0.588,-0.365 0.576,-0.351 0.567,-0.333C0.559,-0.315 0.555,-0.293 0.555,-0.268L0.555,-0L0.406,-0L0.406,-0.274C0.406,-0.31 0.398,-0.339 0.384,-0.359C0.369,-0.38 0.346,-0.39 0.313,-0.39C0.294,-0.39 0.277,-0.385 0.262,-0.375C0.247,-0.365 0.236,-0.351 0.227,-0.333C0.219,-0.315 0.215,-0.293 0.215,-0.268L0.215,-0L0.065,-0Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,271.421138,995.893937)">
      <path d="M0.237,0.012C0.195,0.012 0.16,0.005 0.133,-0.008C0.105,-0.022 0.085,-0.04 0.072,-0.063C0.058,-0.086 0.052,-0.111 0.052,-0.139C0.052,-0.169 0.059,-0.195 0.074,-0.218C0.09,-0.242 0.113,-0.26 0.145,-0.273C0.177,-0.287 0.217,-0.294 0.266,-0.294L0.388,-0.294C0.388,-0.317 0.385,-0.336 0.38,-0.35C0.374,-0.365 0.365,-0.376 0.352,-0.383C0.339,-0.391 0.322,-0.394 0.3,-0.394C0.277,-0.394 0.257,-0.39 0.241,-0.38C0.225,-0.37 0.215,-0.356 0.211,-0.336L0.067,-0.336C0.07,-0.372 0.082,-0.403 0.102,-0.43C0.122,-0.457 0.15,-0.478 0.184,-0.493C0.218,-0.508 0.257,-0.515 0.301,-0.515C0.349,-0.515 0.39,-0.508 0.426,-0.492C0.462,-0.477 0.489,-0.454 0.509,-0.424C0.528,-0.394 0.538,-0.357 0.538,-0.312L0.538,-0L0.413,-0L0.395,-0.073C0.388,-0.061 0.379,-0.049 0.369,-0.039C0.359,-0.028 0.347,-0.019 0.334,-0.012C0.321,-0.004 0.306,0.002 0.29,0.006C0.274,0.01 0.256,0.012 0.237,0.012ZM0.274,-0.102C0.29,-0.102 0.304,-0.105 0.316,-0.11C0.328,-0.115 0.338,-0.123 0.347,-0.132C0.356,-0.141 0.363,-0.152 0.369,-0.165C0.374,-0.177 0.378,-0.191 0.381,-0.205L0.381,-0.206L0.284,-0.206C0.268,-0.206 0.254,-0.204 0.243,-0.199C0.232,-0.195 0.223,-0.189 0.218,-0.181C0.213,-0.173 0.21,-0.163 0.21,-0.153C0.21,-0.142 0.213,-0.132 0.218,-0.125C0.224,-0.117 0.232,-0.112 0.241,-0.108C0.251,-0.104 0.262,-0.102 0.274,-0.102Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,301.321138,995.893937)">
      <path d="M0.314,0.012C0.262,0.012 0.216,0.001 0.177,-0.022C0.137,-0.045 0.106,-0.076 0.084,-0.115C0.062,-0.155 0.05,-0.199 0.05,-0.25C0.05,-0.302 0.062,-0.347 0.084,-0.387C0.106,-0.427 0.137,-0.458 0.177,-0.481C0.216,-0.504 0.262,-0.515 0.314,-0.515C0.38,-0.515 0.435,-0.498 0.48,-0.464C0.525,-0.429 0.554,-0.381 0.566,-0.319L0.407,-0.319C0.401,-0.341 0.39,-0.357 0.373,-0.369C0.357,-0.381 0.336,-0.387 0.313,-0.387C0.291,-0.387 0.272,-0.382 0.255,-0.371C0.239,-0.36 0.226,-0.344 0.217,-0.324C0.208,-0.303 0.203,-0.279 0.203,-0.252C0.203,-0.231 0.206,-0.213 0.211,-0.196C0.216,-0.179 0.224,-0.165 0.233,-0.153C0.243,-0.141 0.255,-0.132 0.268,-0.125C0.281,-0.119 0.296,-0.116 0.313,-0.116C0.329,-0.116 0.343,-0.119 0.355,-0.124C0.368,-0.129 0.379,-0.137 0.388,-0.147C0.397,-0.157 0.403,-0.17 0.407,-0.184L0.566,-0.184C0.554,-0.124 0.525,-0.076 0.48,-0.041C0.435,-0.006 0.38,0.012 0.314,0.012Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,332.171138,995.893937)">
      <path d="M0.065,-0L0.065,-0.72L0.215,-0.72L0.215,-0.432C0.231,-0.457 0.253,-0.477 0.28,-0.493C0.307,-0.508 0.339,-0.515 0.376,-0.515C0.419,-0.515 0.455,-0.507 0.483,-0.489C0.512,-0.471 0.534,-0.445 0.548,-0.411C0.563,-0.377 0.57,-0.335 0.57,-0.286L0.57,-0L0.421,-0L0.421,-0.272C0.421,-0.31 0.413,-0.338 0.398,-0.359C0.382,-0.379 0.357,-0.39 0.323,-0.39C0.303,-0.39 0.284,-0.385 0.268,-0.375C0.251,-0.365 0.238,-0.351 0.229,-0.333C0.22,-0.314 0.215,-0.292 0.215,-0.267L0.215,-0L0.065,-0Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,363.671138,995.893937)">
      <path d="M0.067,-0L0.067,-0.504L0.217,-0.504L0.217,-0L0.067,-0ZM0.142,-0.562C0.115,-0.562 0.094,-0.569 0.077,-0.585C0.06,-0.601 0.052,-0.62 0.052,-0.643C0.052,-0.667 0.06,-0.687 0.077,-0.702C0.094,-0.717 0.115,-0.725 0.142,-0.725C0.169,-0.725 0.191,-0.717 0.208,-0.702C0.225,-0.687 0.234,-0.667 0.234,-0.643C0.234,-0.62 0.225,-0.601 0.208,-0.585C0.191,-0.569 0.169,-0.562 0.142,-0.562Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,377.871138,995.893937)">
      <path d="M0.065,-0L0.065,-0.504L0.196,-0.504L0.208,-0.423C0.223,-0.451 0.245,-0.473 0.273,-0.49C0.301,-0.507 0.335,-0.515 0.375,-0.515C0.417,-0.515 0.452,-0.507 0.481,-0.489C0.51,-0.471 0.531,-0.445 0.546,-0.411C0.561,-0.378 0.569,-0.336 0.569,-0.288L0.569,-0L0.42,-0L0.42,-0.274C0.42,-0.311 0.412,-0.339 0.396,-0.359C0.381,-0.38 0.356,-0.39 0.322,-0.39C0.302,-0.39 0.284,-0.385 0.267,-0.375C0.251,-0.365 0.238,-0.352 0.229,-0.334C0.22,-0.316 0.215,-0.294 0.215,-0.269L0.215,-0L0.065,-0Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,409.321138,995.893937)">
      <path d="M0.313,0.012C0.261,0.012 0.215,0.001 0.176,-0.021C0.136,-0.042 0.106,-0.073 0.084,-0.111C0.061,-0.15 0.05,-0.195 0.05,-0.246C0.05,-0.298 0.061,-0.344 0.083,-0.385C0.105,-0.425 0.135,-0.457 0.175,-0.481C0.214,-0.504 0.26,-0.515 0.312,-0.515C0.363,-0.515 0.407,-0.505 0.445,-0.483C0.483,-0.461 0.513,-0.431 0.535,-0.393C0.556,-0.356 0.567,-0.312 0.567,-0.263C0.567,-0.256 0.567,-0.249 0.566,-0.24C0.566,-0.232 0.565,-0.223 0.564,-0.215L0.157,-0.215L0.157,-0.302L0.414,-0.302C0.413,-0.33 0.403,-0.353 0.384,-0.37C0.365,-0.387 0.341,-0.395 0.313,-0.395C0.292,-0.395 0.273,-0.39 0.255,-0.38C0.237,-0.37 0.224,-0.355 0.213,-0.335C0.203,-0.315 0.198,-0.29 0.198,-0.259L0.198,-0.229C0.198,-0.206 0.203,-0.185 0.212,-0.167C0.221,-0.149 0.234,-0.135 0.251,-0.125C0.268,-0.115 0.288,-0.11 0.311,-0.11C0.333,-0.11 0.351,-0.114 0.366,-0.123C0.38,-0.132 0.391,-0.144 0.399,-0.158L0.552,-0.158C0.543,-0.126 0.526,-0.097 0.504,-0.072C0.481,-0.046 0.454,-0.026 0.421,-0.011C0.389,0.004 0.352,0.012 0.313,0.012Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,439.921138,995.893937)">
      <path d="M0.275,0.012C0.228,0.012 0.187,0.004 0.152,-0.011C0.118,-0.026 0.091,-0.046 0.071,-0.072C0.052,-0.098 0.04,-0.127 0.038,-0.16L0.187,-0.16C0.189,-0.149 0.194,-0.139 0.201,-0.13C0.209,-0.121 0.218,-0.114 0.231,-0.109C0.243,-0.103 0.257,-0.101 0.272,-0.101C0.289,-0.101 0.302,-0.103 0.313,-0.107C0.323,-0.112 0.331,-0.118 0.336,-0.125C0.341,-0.133 0.344,-0.14 0.344,-0.148C0.344,-0.161 0.34,-0.17 0.332,-0.177C0.325,-0.183 0.313,-0.189 0.299,-0.193C0.284,-0.198 0.267,-0.202 0.246,-0.206C0.222,-0.211 0.198,-0.218 0.175,-0.224C0.151,-0.231 0.13,-0.24 0.112,-0.251C0.093,-0.262 0.078,-0.276 0.067,-0.292C0.056,-0.309 0.051,-0.33 0.051,-0.355C0.051,-0.385 0.059,-0.412 0.076,-0.437C0.092,-0.461 0.116,-0.48 0.148,-0.494C0.179,-0.508 0.218,-0.515 0.262,-0.515C0.325,-0.515 0.375,-0.502 0.411,-0.474C0.447,-0.446 0.468,-0.409 0.475,-0.361L0.335,-0.361C0.331,-0.374 0.323,-0.384 0.31,-0.391C0.298,-0.398 0.281,-0.402 0.262,-0.402C0.24,-0.402 0.224,-0.398 0.212,-0.391C0.201,-0.383 0.195,-0.374 0.195,-0.362C0.195,-0.354 0.199,-0.347 0.207,-0.34C0.214,-0.334 0.226,-0.328 0.24,-0.324C0.255,-0.319 0.273,-0.314 0.294,-0.31C0.334,-0.301 0.37,-0.292 0.399,-0.282C0.429,-0.272 0.452,-0.257 0.469,-0.238C0.485,-0.219 0.494,-0.192 0.493,-0.156C0.494,-0.123 0.485,-0.094 0.467,-0.069C0.449,-0.044 0.424,-0.024 0.392,-0.01C0.359,0.005 0.32,0.012 0.275,0.012Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,466.921138,995.893937)">
      <path d="M0.135,0.005C0.107,0.005 0.085,-0.003 0.068,-0.019C0.052,-0.036 0.043,-0.055 0.043,-0.079C0.043,-0.103 0.052,-0.123 0.068,-0.139C0.085,-0.155 0.107,-0.164 0.135,-0.164C0.161,-0.164 0.183,-0.155 0.2,-0.139C0.217,-0.123 0.225,-0.103 0.225,-0.079C0.225,-0.055 0.217,-0.036 0.2,-0.019C0.183,-0.003 0.161,0.005 0.135,0.005Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,480.321138,995.893937)">
      <path d="M0.065,-0L0.065,-0.504L0.196,-0.504L0.208,-0.423C0.223,-0.451 0.245,-0.473 0.273,-0.49C0.301,-0.507 0.335,-0.515 0.375,-0.515C0.417,-0.515 0.452,-0.507 0.481,-0.489C0.51,-0.471 0.531,-0.445 0.546,-0.411C0.561,-0.378 0.569,-0.336 0.569,-0.288L0.569,-0L0.42,-0L0.42,-0.274C0.42,-0.311 0.412,-0.339 0.396,-0.359C0.381,-0.38 0.356,-0.39 0.322,-0.39C0.302,-0.39 0.284,-0.385 0.267,-0.375C0.251,-0.365 0.238,-0.352 0.229,-0.334C0.22,-0.316 0.215,-0.294 0.215,-0.269L0.215,-0L0.065,-0Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,511.771138,995.893937)">
      <rect x="0.065" y="-0.72" width="0.15" height="0.72" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,525.771138,995.893937)">
      <path d="M0.021,0.119L0.271,-0.784L0.416,-0.784L0.166,0.119L0.021,0.119Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,547.621138,995.893937)">
      <path d="M0.255,0.012C0.213,0.012 0.178,0.003 0.149,-0.014C0.12,-0.031 0.098,-0.057 0.083,-0.09C0.068,-0.124 0.06,-0.165 0.06,-0.214L0.06,-0.504L0.21,-0.504L0.21,-0.229C0.21,-0.192 0.217,-0.163 0.233,-0.143C0.248,-0.124 0.273,-0.114 0.307,-0.114C0.328,-0.114 0.346,-0.119 0.362,-0.128C0.379,-0.138 0.391,-0.151 0.4,-0.169C0.41,-0.187 0.414,-0.209 0.414,-0.235L0.414,-0.504L0.564,-0.504L0.564,-0L0.433,-0L0.421,-0.08C0.406,-0.053 0.385,-0.03 0.357,-0.013C0.329,0.004 0.295,0.012 0.255,0.012Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,579.071138,995.893937)">
      <rect x="0.065" y="-0.72" width="0.15" height="0.72" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,593.071138,995.893937)">
      <path d="M0.3,-0C0.264,-0 0.232,-0.006 0.204,-0.017C0.176,-0.029 0.154,-0.048 0.139,-0.075C0.124,-0.101 0.116,-0.138 0.116,-0.184L0.116,-0.379L0.03,-0.379L0.03,-0.504L0.116,-0.504L0.132,-0.646L0.266,-0.646L0.266,-0.504L0.395,-0.504L0.395,-0.379L0.266,-0.379L0.266,-0.182C0.266,-0.162 0.27,-0.148 0.28,-0.14C0.289,-0.131 0.304,-0.127 0.326,-0.127L0.395,-0.127L0.395,-0L0.3,-0Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,615.321138,995.893937)">
      <path d="M0.067,-0L0.067,-0.504L0.217,-0.504L0.217,-0L0.067,-0ZM0.142,-0.562C0.115,-0.562 0.094,-0.569 0.077,-0.585C0.06,-0.601 0.052,-0.62 0.052,-0.643C0.052,-0.667 0.06,-0.687 0.077,-0.702C0.094,-0.717 0.115,-0.725 0.142,-0.725C0.169,-0.725 0.191,-0.717 0.208,-0.702C0.225,-0.687 0.234,-0.667 0.234,-0.643C0.234,-0.62 0.225,-0.601 0.208,-0.585C0.191,-0.569 0.169,-0.562 0.142,-0.562Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,629.521138,995.893937)">
      <path d="M0.065,-0L0.065,-0.504L0.196,-0.504L0.209,-0.439C0.225,-0.462 0.246,-0.481 0.272,-0.495C0.299,-0.509 0.329,-0.515 0.364,-0.515C0.388,-0.515 0.411,-0.512 0.431,-0.506C0.451,-0.5 0.468,-0.491 0.484,-0.478C0.499,-0.466 0.512,-0.451 0.522,-0.432C0.541,-0.458 0.566,-0.478 0.596,-0.493C0.626,-0.508 0.659,-0.515 0.694,-0.515C0.739,-0.515 0.777,-0.507 0.806,-0.489C0.836,-0.471 0.858,-0.445 0.873,-0.411C0.888,-0.377 0.895,-0.336 0.895,-0.287L0.895,-0L0.746,-0L0.746,-0.274C0.746,-0.31 0.739,-0.339 0.724,-0.359C0.71,-0.38 0.687,-0.39 0.656,-0.39C0.636,-0.39 0.618,-0.385 0.603,-0.375C0.588,-0.365 0.576,-0.351 0.567,-0.333C0.559,-0.315 0.555,-0.293 0.555,-0.268L0.555,-0L0.406,-0L0.406,-0.274C0.406,-0.31 0.398,-0.339 0.384,-0.359C0.369,-0.38 0.346,-0.39 0.313,-0.39C0.294,-0.39 0.277,-0.385 0.262,-0.375C0.247,-0.365 0.236,-0.351 0.227,-0.333C0.219,-0.315 0.215,-0.293 0.215,-0.268L0.215,-0L0.065,-0Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,677.271138,995.893937)">
      <path d="M0.237,0.012C0.195,0.012 0.16,0.005 0.133,-0.008C0.105,-0.022 0.085,-0.04 0.072,-0.063C0.058,-0.086 0.052,-0.111 0.052,-0.139C0.052,-0.169 0.059,-0.195 0.074,-0.218C0.09,-0.242 0.113,-0.26 0.145,-0.273C0.177,-0.287 0.217,-0.294 0.266,-0.294L0.388,-0.294C0.388,-0.317 0.385,-0.336 0.38,-0.35C0.374,-0.365 0.365,-0.376 0.352,-0.383C0.339,-0.391 0.322,-0.394 0.3,-0.394C0.277,-0.394 0.257,-0.39 0.241,-0.38C0.225,-0.37 0.215,-0.356 0.211,-0.336L0.067,-0.336C0.07,-0.372 0.082,-0.403 0.102,-0.43C0.122,-0.457 0.15,-0.478 0.184,-0.493C0.218,-0.508 0.257,-0.515 0.301,-0.515C0.349,-0.515 0.39,-0.508 0.426,-0.492C0.462,-0.477 0.489,-0.454 0.509,-0.424C0.528,-0.394 0.538,-0.357 0.538,-0.312L0.538,-0L0.413,-0L0.395,-0.073C0.388,-0.061 0.379,-0.049 0.369,-0.039C0.359,-0.028 0.347,-0.019 0.334,-0.012C0.321,-0.004 0.306,0.002 0.29,0.006C0.274,0.01 0.256,0.012 0.237,0.012ZM0.274,-0.102C0.29,-0.102 0.304,-0.105 0.316,-0.11C0.328,-0.115 0.338,-0.123 0.347,-0.132C0.356,-0.141 0.363,-0.152 0.369,-0.165C0.374,-0.177 0.378,-0.191 0.381,-0.205L0.381,-0.206L0.284,-0.206C0.268,-0.206 0.254,-0.204 0.243,-0.199C0.232,-0.195 0.223,-0.189 0.218,-0.181C0.213,-0.173 0.21,-0.163 0.21,-0.153C0.21,-0.142 0.213,-0.132 0.218,-0.125C0.224,-0.117 0.232,-0.112 0.241,-0.108C0.251,-0.104 0.262,-0.102 0.274,-0.102Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,707.021138,995.893937)">
      <path d="M0.3,-0C0.264,-0 0.232,-0.006 0.204,-0.017C0.176,-0.029 0.154,-0.048 0.139,-0.075C0.124,-0.101 0.116,-0.138 0.116,-0.184L0.116,-0.379L0.03,-0.379L0.03,-0.504L0.116,-0.504L0.132,-0.646L0.266,-0.646L0.266,-0.504L0.395,-0.504L0.395,-0.379L0.266,-0.379L0.266,-0.182C0.266,-0.162 0.27,-0.148 0.28,-0.14C0.289,-0.131 0.304,-0.127 0.326,-0.127L0.395,-0.127L0.395,-0L0.3,-0Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,728.671138,995.893937)">
      <path d="M0.313,0.012C0.261,0.012 0.215,0.001 0.176,-0.021C0.136,-0.042 0.106,-0.073 0.084,-0.111C0.061,-0.15 0.05,-0.195 0.05,-0.246C0.05,-0.298 0.061,-0.344 0.083,-0.385C0.105,-0.425 0.135,-0.457 0.175,-0.481C0.214,-0.504 0.26,-0.515 0.312,-0.515C0.363,-0.515 0.407,-0.505 0.445,-0.483C0.483,-0.461 0.513,-0.431 0.535,-0.393C0.556,-0.356 0.567,-0.312 0.567,-0.263C0.567,-0.256 0.567,-0.249 0.566,-0.24C0.566,-0.232 0.565,-0.223 0.564,-0.215L0.157,-0.215L0.157,-0.302L0.414,-0.302C0.413,-0.33 0.403,-0.353 0.384,-0.37C0.365,-0.387 0.341,-0.395 0.313,-0.395C0.292,-0.395 0.273,-0.39 0.255,-0.38C0.237,-0.37 0.224,-0.355 0.213,-0.335C0.203,-0.315 0.198,-0.29 0.198,-0.259L0.198,-0.229C0.198,-0.206 0.203,-0.185 0.212,-0.167C0.221,-0.149 0.234,-0.135 0.251,-0.125C0.268,-0.115 0.288,-0.11 0.311,-0.11C0.333,-0.11 0.351,-0.114 0.366,-0.123C0.38,-0.132 0.391,-0.144 0.399,-0.158L0.552,-0.158C0.543,-0.126 0.526,-0.097 0.504,-0.072C0.481,-0.046 0.454,-0.026 0.421,-0.011C0.389,0.004 0.352,0.012 0.313,0.012Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,759.271138,995.893937)">
      <path d="M0.065,0.22L0.065,-0.504L0.198,-0.504L0.215,-0.438C0.225,-0.452 0.238,-0.465 0.252,-0.477C0.266,-0.489 0.283,-0.498 0.303,-0.505C0.322,-0.512 0.345,-0.515 0.372,-0.515C0.418,-0.515 0.46,-0.504 0.495,-0.481C0.531,-0.458 0.56,-0.427 0.581,-0.387C0.602,-0.347 0.613,-0.302 0.613,-0.251C0.613,-0.2 0.602,-0.155 0.58,-0.116C0.559,-0.076 0.53,-0.045 0.494,-0.022C0.458,0.001 0.418,0.012 0.373,0.012C0.337,0.012 0.306,0.006 0.28,-0.007C0.254,-0.02 0.232,-0.037 0.215,-0.06L0.215,0.22L0.065,0.22ZM0.335,-0.119C0.359,-0.119 0.38,-0.124 0.399,-0.135C0.418,-0.147 0.433,-0.162 0.444,-0.182C0.455,-0.202 0.46,-0.225 0.46,-0.251C0.46,-0.277 0.455,-0.3 0.444,-0.32C0.433,-0.34 0.418,-0.356 0.399,-0.368C0.38,-0.379 0.359,-0.385 0.335,-0.385C0.31,-0.385 0.289,-0.379 0.27,-0.368C0.251,-0.356 0.236,-0.34 0.225,-0.32C0.215,-0.3 0.209,-0.278 0.209,-0.252C0.209,-0.226 0.215,-0.203 0.225,-0.183C0.236,-0.163 0.251,-0.147 0.27,-0.136C0.289,-0.124 0.31,-0.119 0.335,-0.119Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,792.421138,995.893937)">
      <path d="M0.237,0.012C0.195,0.012 0.16,0.005 0.133,-0.008C0.105,-0.022 0.085,-0.04 0.072,-0.063C0.058,-0.086 0.052,-0.111 0.052,-0.139C0.052,-0.169 0.059,-0.195 0.074,-0.218C0.09,-0.242 0.113,-0.26 0.145,-0.273C0.177,-0.287 0.217,-0.294 0.266,-0.294L0.388,-0.294C0.388,-0.317 0.385,-0.336 0.38,-0.35C0.374,-0.365 0.365,-0.376 0.352,-0.383C0.339,-0.391 0.322,-0.394 0.3,-0.394C0.277,-0.394 0.257,-0.39 0.241,-0.38C0.225,-0.37 0.215,-0.356 0.211,-0.336L0.067,-0.336C0.07,-0.372 0.082,-0.403 0.102,-0.43C0.122,-0.457 0.15,-0.478 0.184,-0.493C0.218,-0.508 0.257,-0.515 0.301,-0.515C0.349,-0.515 0.39,-0.508 0.426,-0.492C0.462,-0.477 0.489,-0.454 0.509,-0.424C0.528,-0.394 0.538,-0.357 0.538,-0.312L0.538,-0L0.413,-0L0.395,-0.073C0.388,-0.061 0.379,-0.049 0.369,-0.039C0.359,-0.028 0.347,-0.019 0.334,-0.012C0.321,-0.004 0.306,0.002 0.29,0.006C0.274,0.01 0.256,0.012 0.237,0.012ZM0.274,-0.102C0.29,-0.102 0.304,-0.105 0.316,-0.11C0.328,-0.115 0.338,-0.123 0.347,-0.132C0.356,-0.141 0.363,-0.152 0.369,-0.165C0.374,-0.177 0.378,-0.191 0.381,-0.205L0.381,-0.206L0.284,-0.206C0.268,-0.206 0.254,-0.204 0.243,-0.199C0.232,-0.195 0.223,-0.189 0.218,-0.181C0.213,-0.173 0.21,-0.163 0.21,-0.153C0.21,-0.142 0.213,-0.132 0.218,-0.125C0.224,-0.117 0.232,-0.112 0.241,-0.108C0.251,-0.104 0.262,-0.102 0.274,-0.102Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,822.321138,995.893937)">
      <path d="M0.065,0.22L0.065,-0.504L0.198,-0.504L0.215,-0.438C0.225,-0.452 0.238,-0.465 0.252,-0.477C0.266,-0.489 0.283,-0.498 0.303,-0.505C0.322,-0.512 0.345,-0.515 0.372,-0.515C0.418,-0.515 0.46,-0.504 0.495,-0.481C0.531,-0.458 0.56,-0.427 0.581,-0.387C0.602,-0.347 0.613,-0.302 0.613,-0.251C0.613,-0.2 0.602,-0.155 0.58,-0.116C0.559,-0.076 0.53,-0.045 0.494,-0.022C0.458,0.001 0.418,0.012 0.373,0.012C0.337,0.012 0.306,0.006 0.28,-0.007C0.254,-0.02 0.232,-0.037 0.215,-0.06L0.215,0.22L0.065,0.22ZM0.335,-0.119C0.359,-0.119 0.38,-0.124 0.399,-0.135C0.418,-0.147 0.433,-0.162 0.444,-0.182C0.455,-0.202 0.46,-0.225 0.46,-0.251C0.46,-0.277 0.455,-0.3 0.444,-0.32C0.433,-0.34 0.418,-0.356 0.399,-0.368C0.38,-0.379 0.359,-0.385 0.335,-0.385C0.31,-0.385 0.289,-0.379 0.27,-0.368C0.251,-0.356 0.236,-0.34 0.225,-0.32C0.215,-0.3 0.209,-0.278 0.209,-0.252C0.209,-0.226 0.215,-0.203 0.225,-0.183C0.236,-0.163 0.251,-0.147 0.27,-0.136C0.289,-0.124 0.31,-0.119 0.335,-0.119Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,855.471138,995.893937)">
      <path d="M0.313,0.012C0.261,0.012 0.215,0.001 0.176,-0.021C0.136,-0.042 0.106,-0.073 0.084,-0.111C0.061,-0.15 0.05,-0.195 0.05,-0.246C0.05,-0.298 0.061,-0.344 0.083,-0.385C0.105,-0.425 0.135,-0.457 0.175,-0.481C0.214,-0.504 0.26,-0.515 0.312,-0.515C0.363,-0.515 0.407,-0.505 0.445,-0.483C0.483,-0.461 0.513,-0.431 0.535,-0.393C0.556,-0.356 0.567,-0.312 0.567,-0.263C0.567,-0.256 0.567,-0.249 0.566,-0.24C0.566,-0.232 0.565,-0.223 0.564,-0.215L0.157,-0.215L0.157,-0.302L0.414,-0.302C0.413,-0.33 0.403,-0.353 0.384,-0.37C0.365,-0.387 0.341,-0.395 0.313,-0.395C0.292,-0.395 0.273,-0.39 0.255,-0.38C0.237,-0.37 0.224,-0.355 0.213,-0.335C0.203,-0.315 0.198,-0.29 0.198,-0.259L0.198,-0.229C0.198,-0.206 0.203,-0.185 0.212,-0.167C0.221,-0.149 0.234,-0.135 0.251,-0.125C0.268,-0.115 0.288,-0.11 0.311,-0.11C0.333,-0.11 0.351,-0.114 0.366,-0.123C0.38,-0.132 0.391,-0.144 0.399,-0.158L0.552,-0.158C0.543,-0.126 0.526,-0.097 0.504,-0.072C0.481,-0.046 0.454,-0.026 0.421,-0.011C0.389,0.004 0.352,0.012 0.313,0.012Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,886.071138,995.893937)">
      <path d="M0.065,-0L0.065,-0.504L0.198,-0.504L0.212,-0.412C0.225,-0.433 0.241,-0.452 0.259,-0.467C0.277,-0.483 0.298,-0.494 0.321,-0.503C0.345,-0.511 0.371,-0.515 0.398,-0.515L0.398,-0.357L0.348,-0.357C0.328,-0.357 0.31,-0.355 0.294,-0.351C0.277,-0.346 0.263,-0.339 0.251,-0.329C0.24,-0.319 0.231,-0.306 0.224,-0.289C0.218,-0.272 0.215,-0.251 0.215,-0.225L0.215,-0L0.065,-0Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,907.071138,995.893937)">
      <path d="M0.372,0.012C0.347,0.012 0.325,0.009 0.305,0.003C0.286,-0.003 0.268,-0.012 0.253,-0.022C0.238,-0.033 0.226,-0.046 0.215,-0.06L0.198,-0L0.065,-0L0.065,-0.72L0.215,-0.72L0.215,-0.438C0.231,-0.461 0.251,-0.479 0.277,-0.494C0.302,-0.508 0.334,-0.515 0.371,-0.515C0.417,-0.515 0.458,-0.504 0.495,-0.481C0.531,-0.458 0.559,-0.427 0.581,-0.387C0.602,-0.348 0.613,-0.302 0.613,-0.251C0.613,-0.201 0.602,-0.156 0.581,-0.116C0.56,-0.076 0.531,-0.045 0.495,-0.022C0.459,0.001 0.418,0.012 0.372,0.012ZM0.335,-0.119C0.359,-0.119 0.381,-0.124 0.399,-0.136C0.418,-0.147 0.433,-0.163 0.444,-0.182C0.454,-0.202 0.46,-0.225 0.46,-0.251C0.46,-0.277 0.454,-0.3 0.444,-0.32C0.433,-0.34 0.418,-0.356 0.399,-0.368C0.381,-0.379 0.359,-0.385 0.335,-0.385C0.31,-0.385 0.289,-0.379 0.27,-0.368C0.251,-0.356 0.236,-0.34 0.225,-0.321C0.215,-0.301 0.209,-0.278 0.209,-0.251C0.209,-0.226 0.215,-0.203 0.225,-0.183C0.236,-0.163 0.251,-0.147 0.27,-0.136C0.289,-0.124 0.31,-0.119 0.335,-0.119Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,940.221138,995.893937)">
      <path d="M0.307,0.012C0.258,0.012 0.215,0.001 0.176,-0.022C0.137,-0.045 0.106,-0.076 0.084,-0.116C0.062,-0.155 0.05,-0.201 0.05,-0.251C0.05,-0.303 0.062,-0.349 0.084,-0.389C0.107,-0.428 0.137,-0.459 0.176,-0.482C0.215,-0.504 0.259,-0.515 0.307,-0.515C0.356,-0.515 0.4,-0.504 0.439,-0.482C0.478,-0.459 0.509,-0.428 0.531,-0.389C0.553,-0.349 0.565,-0.303 0.565,-0.252C0.565,-0.2 0.553,-0.155 0.531,-0.115C0.508,-0.076 0.478,-0.045 0.439,-0.022C0.4,0.001 0.356,0.012 0.307,0.012ZM0.307,-0.118C0.327,-0.118 0.345,-0.123 0.361,-0.133C0.376,-0.143 0.389,-0.158 0.398,-0.178C0.407,-0.198 0.412,-0.222 0.412,-0.252C0.412,-0.281 0.407,-0.306 0.398,-0.326C0.389,-0.346 0.377,-0.361 0.361,-0.371C0.346,-0.381 0.328,-0.386 0.308,-0.386C0.288,-0.386 0.271,-0.381 0.255,-0.371C0.239,-0.361 0.226,-0.346 0.217,-0.326C0.208,-0.306 0.203,-0.281 0.203,-0.252C0.203,-0.222 0.208,-0.198 0.217,-0.178C0.226,-0.158 0.239,-0.143 0.254,-0.133C0.27,-0.123 0.288,-0.118 0.307,-0.118Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,969.571138,995.893937)">
      <path d="M0.019,-0L0.203,-0.252L0.019,-0.504L0.181,-0.504L0.297,-0.341L0.413,-0.504L0.574,-0.504L0.39,-0.252L0.574,-0L0.413,-0L0.297,-0.164L0.181,-0L0.019,-0Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,997.821138,995.893937)">
      <path d="M0.313,0.012C0.261,0.012 0.215,0.001 0.176,-0.021C0.136,-0.042 0.106,-0.073 0.084,-0.111C0.061,-0.15 0.05,-0.195 0.05,-0.246C0.05,-0.298 0.061,-0.344 0.083,-0.385C0.105,-0.425 0.135,-0.457 0.175,-0.481C0.214,-0.504 0.26,-0.515 0.312,-0.515C0.363,-0.515 0.407,-0.505 0.445,-0.483C0.483,-0.461 0.513,-0.431 0.535,-0.393C0.556,-0.356 0.567,-0.312 0.567,-0.263C0.567,-0.256 0.567,-0.249 0.566,-0.24C0.566,-0.232 0.565,-0.223 0.564,-0.215L0.157,-0.215L0.157,-0.302L0.414,-0.302C0.413,-0.33 0.403,-0.353 0.384,-0.37C0.365,-0.387 0.341,-0.395 0.313,-0.395C0.292,-0.395 0.273,-0.39 0.255,-0.38C0.237,-0.37 0.224,-0.355 0.213,-0.335C0.203,-0.315 0.198,-0.29 0.198,-0.259L0.198,-0.229C0.198,-0.206 0.203,-0.185 0.212,-0.167C0.221,-0.149 0.234,-0.135 0.251,-0.125C0.268,-0.115 0.288,-0.11 0.311,-0.11C0.333,-0.11 0.351,-0.114 0.366,-0.123C0.38,-0.132 0.391,-0.144 0.399,-0.158L0.552,-0.158C0.543,-0.126 0.526,-0.097 0.504,-0.072C0.481,-0.046 0.454,-0.026 0.421,-0.011C0.389,0.004 0.352,0.012 0.313,0.012Z" style="fill-rule:nonzero;"/>
    </g>
    <g transform="matrix(50,0,0,50,1028.421138,995.893937)">
      <path d="M0.275,0.012C0.228,0.012 0.187,0.004 0.152,-0.011C0.118,-0.026 0.091,-0.046 0.071,-0.072C0.052,-0.098 0.04,-0.127 0.038,-0.16L0.187,-0.16C0.189,-0.149 0.194,-0.139 0.201,-0.13C0.209,-0.121 0.218,-0.114 0.231,-0.109C0.243,-0.103 0.257,-0.101 0.272,-0.101C0.289,-0.101 0.302,-0.103 0.313,-0.107C0.323,-0.112 0.331,-0.118 0.336,-0.125C0.341,-0.133 0.344,-0.14 0.344,-0.148C0.344,-0.161 0.34,-0.17 0.332,-0.177C0.325,-0.183 0.313,-0.189 0.299,-0.193C0.284,-0.198 0.267,-0.202 0.246,-0.206C0.222,-0.211 0.198,-0.218 0.175,-0.224C0.151,-0.231 0.13,-0.24 0.112,-0.251C0.093,-0.262 0.078,-0.276 0.067,-0.292C0.056,-0.309 0.051,-0.33 0.051,-0.355C0.051,-0.385 0.059,-0.412 0.076,-0.437C0.092,-0.461 0.116,-0.48 0.148,-0.494C0.179,-0.508 0.218,-0.515 0.262,-0.515C0.325,-0.515 0.375,-0.502 0.411,-0.474C0.447,-0.446 0.468,-0.409 0.475,-0.361L0.335,-0.361C0.331,-0.374 0.323,-0.384 0.31,-0.391C0.298,-0.398 0.281,-0.402 0.262,-0.402C0.24,-0.402 0.224,-0.398 0.212,-0.391C0.201,-0.383 0.195,-0.374 0.195,-0.362C0.195,-0.354 0.199,-0.347 0.207,-0.34C0.214,-0.334 0.226,-0.328 0.24,-0.324C0.255,-0.319 0.273,-0.314 0.294,-0.31C0.334,-0.301 0.37,-0.292 0.399,-0.282C0.429,-0.272 0.452,-0.257 0.469,-0.238C0.485,-0.219 0.494,-0.192 0.493,-0.156C0.494,-0.123 0.485,-0.094 0.467,-0.069C0.449,-0.044 0.424,-0.024 0.392,-0.01C0.359,0.005 0.32,0.012 0.275,0.012Z" style="fill-rule:nonzero;"/>
    </g>
  </g>
</g>`;

const FOOTER_LOGO_PATH = "assets/footer-logo.svg";
let footerLogoMarkup = FOOTER_VECTOR_MARKUP;
let footerLogoWidth = FOOTER_VECTOR_WIDTH;
let footerLogoHeight = FOOTER_VECTOR_HEIGHT;

const COLOR_SETTINGS = {
  bleed: 4,
  panelOpacity: 1,
  flapOpacity: 1,
};
const DIMENSION_MATCH_TOLERANCE = 0.05;

function hexToRgb(hex) {
  if (!hex) {
    return null;
  }
  let normalized = hex.replace("#", "");
  if (normalized.length === 3) {
    normalized = normalized
      .split("")
      .map((char) => char + char)
      .join("");
  }
  if (normalized.length !== 6 || Number.isNaN(parseInt(normalized, 16))) {
    return null;
  }
  const value = parseInt(normalized, 16);
  return {
    r: (value >> 16) & 255,
    g: (value >> 8) & 255,
    b: value & 255,
  };
}

function rgbToHex(r, g, b) {
  const toHex = (channel) => {
    const clamped = Math.max(0, Math.min(255, Math.round(channel)));
    return clamped.toString(16).padStart(2, "0");
  };
  return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}

function adjustHexBrightness(hex, lighten = true, amount = 0.35) {
  const rgb = hexToRgb(hex);
  if (!rgb) {
    return hex;
  }
  const target = lighten ? 255 : 0;
  const mix = (channel) => channel + (target - channel) * amount;
  return rgbToHex(mix(rgb.r), mix(rgb.g), mix(rgb.b));
}

function getPerceivedLuminance(hex) {
  const rgb = hexToRgb(hex);
  if (!rgb) {
    return 0;
  }
  const r = rgb.r / 255;
  const g = rgb.g / 255;
  const b = rgb.b / 255;
  return 0.2126 * r + 0.7152 * g + 0.0722 * b;
}

function hexToRgba(hex, alpha = 1) {
  const rgb = hexToRgb(hex);
  if (!rgb) {
    return `rgba(0, 0, 0, ${alpha})`;
  }
  return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
}

function normalizeColorValue(value) {
  if (value === null || value === undefined) {
    return null;
  }
  const trimmed = `${value}`.trim();
  if (!trimmed) {
    return null;
  }
  if (!normalizeColorValue._ctx) {
    const canvas = document.createElement("canvas");
    normalizeColorValue._ctx = canvas.getContext("2d");
  }
  const ctx = normalizeColorValue._ctx;
  if (!ctx) {
    return trimmed;
  }
  const sentinel = "#010203";
  ctx.fillStyle = sentinel;
  ctx.fillStyle = trimmed;
  const normalized = ctx.fillStyle;
  if (!normalized) {
    return null;
  }
  const lowerSentinel = sentinel.toLowerCase();
  if (
    normalized.toLowerCase() === lowerSentinel &&
    trimmed.toLowerCase() !== lowerSentinel
  ) {
    return null;
  }
  return normalized;
}

function normalizeToHex(value) {
  const normalized = normalizeColorValue(value);
  if (!normalized) {
    return { normalized: null, hex: null };
  }

  const trimmed = normalized.trim().toLowerCase();
  const hexFromValue = (() => {
    if (trimmed.startsWith("#")) {
      if (trimmed.length === 4) {
        const [, r, g, b] = trimmed;
        return `#${r}${r}${g}${g}${b}${b}`;
      }
      if (trimmed.length === 7) {
        return trimmed;
      }
      return null;
    }

    const rgbMatch = trimmed.match(
      /^rgba?\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)(?:\s*,\s*([\d.]+)\s*)?\)$/
    );
    if (rgbMatch) {
      const clampChannel = (component) => {
        const channel = Math.round(parseFloat(component));
        return Number.isFinite(channel)
          ? Math.max(0, Math.min(255, channel))
          : null;
      };
      const [r, g, b] = rgbMatch.slice(1, 4).map(clampChannel);
      if ([r, g, b].some((channel) => channel === null)) {
        return null;
      }
      const toHex = (channel) => channel.toString(16).padStart(2, "0");
      return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }

    return null;
  })();

  return {
    normalized,
    hex: hexFromValue,
  };
}

function getStyleConfig({ color }) {
  const base = {
    cut: STYLES.cut,
    fold: { ...STYLES.fold },
    text: { ...STYLES.text },
  };

  if (!color) {
    return base;
  }

  const { hex: normalizedHex } = normalizeToHex(color);
  const workingColor = normalizedHex || color;
  const luminance = getPerceivedLuminance(workingColor);
  const prefersLightText = luminance < 0.5;
  const primaryColor = prefersLightText ? "#ffffff" : "#111827";
  const mutedColor = hexToRgba(primaryColor, prefersLightText ? 0.8 : 0.6);
  const accentAdjustment = prefersLightText ? 0.2 : 0.25;
  const accentColor = adjustHexBrightness(
    workingColor,
    prefersLightText,
    accentAdjustment
  );

  base.text = {
    primary: `fill:${primaryColor}; font-size: 4px; font-family: sans-serif; text-anchor: middle; alignment-baseline: middle;`,
    muted: `fill:${mutedColor}; font-size: 4px; font-family: sans-serif; text-anchor: middle; alignment-baseline: middle;`,
  };

  if (accentColor) {
    base.fold = {
      ...base.fold,
      accent: `stroke:${accentColor}; stroke-width:0.25; fill:none;`,
    };
  }

  return base;
}

function createLineElement(x1, y1, x2, y2, style) {
  return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" style="${style}" />`;
}

function createRectElement(x, y, width, height, style) {
  return `<rect x="${x}" y="${y}" width="${width}" height="${height}" style="${style}" />`;
}

function createTextElement({ x, y, content, style, rotation }) {
  const rotationAttr = rotation
    ? ` transform="rotate(${rotation} ${x} ${y})"`
    : "";
  return `<text x="${x}" y="${y}" style="${style}"${rotationAttr}>${content}</text>`;
}

function computeLayout(W, H, D, allowance, insideClearance = 3) {
  const { margin, panelGHeight, sideFlapWidth } = LAYOUT_CONSTANTS;

  const y0 = margin;
  const adjustedInsideClearance = Math.max(0, insideClearance);
  const topPanelDepth = Math.max(0, D - adjustedInsideClearance);
  const y1 = y0 + topPanelDepth;
  const y2 = y1 + H;
  const y3 = y2 + H;
  const y4 = y3 + D;
  const y5 = y4 + H;
  const y6 = y5 + H;
  const y7 = y6 + panelGHeight;

  const x0 = margin;
  const x1 = x0 + sideFlapWidth;
  const x2 = x1 + H;
  const x3 = x2 + H;
  const x4 = x3 + W;
  const x5 = x4 + H;
  const x6 = x5 + H;
  const x7 = x6 + sideFlapWidth;

  const p1p2 = {
    width: H - allowance,
    height: W - allowance,
  };

  const p3p4 = {
    width: D - allowance,
    height: H - allowance,
  };

  const flaps = {
    p1: {
      left: x4,
      right: x4 + p1p2.width,
      top: y3 - p1p2.height,
      bottom: y3,
    },
    p2: {
      left: x3 - p1p2.width,
      right: x3,
      top: y4,
      bottom: y4 + p1p2.height,
    },
    p3: {
      left: x3 - p3p4.width,
      right: x3,
      top: y3 - p3p4.height,
      bottom: y3,
    },
    p4: {
      left: x4,
      right: x4 + p3p4.width,
      top: y4,
      bottom: y4 + p3p4.height,
    },
  };

  const minX = Math.min(x0, flaps.p3.left);
  const maxX = Math.max(x7, flaps.p4.right);
  const minY = Math.min(y0, flaps.p1.top);
  const maxY = Math.max(y7, flaps.p2.bottom);

  return {
    x: { x0, x1, x2, x3, x4, x5, x6, x7 },
    y: { y0, y1, y2, y3, y4, y5, y6, y7 },
    flaps,
    viewBox: {
      x: minX - margin,
      y: minY - margin,
      width: maxX - minX + margin * 2,
      height: maxY - minY + margin * 2,
    },
  };
}

function buildFoldLines(layout, styles = STYLES) {
  const { x, y, flaps } = layout;
  const lines = [
    { x1: x.x3, y1: y.y1, x2: x.x4, y2: y.y1, style: styles.fold.valley },
    {
      x1: x.x3,
      y1: y.y2,
      x2: x.x4,
      y2: y.y2,
      style: styles.fold.mountain,
    },
    {
      x1: x.x3,
      y1: y.y3,
      x2: x.x4,
      y2: y.y3,
      style: styles.fold.mountain,
      accent: true,
    },
    {
      x1: x.x3,
      y1: y.y4,
      x2: x.x4,
      y2: y.y4,
      style: styles.fold.mountain,
      accent: true,
    },
    {
      x1: x.x3,
      y1: y.y5,
      x2: x.x4,
      y2: y.y5,
      style: styles.fold.mountain,
    },
    { x1: x.x3, y1: y.y6, x2: x.x4, y2: y.y6, style: styles.fold.valley },
    { x1: x.x1, y1: y.y3, x2: x.x1, y2: y.y4, style: styles.fold.valley },
    {
      x1: x.x2,
      y1: y.y3,
      x2: x.x2,
      y2: y.y4,
      style: styles.fold.mountain,
    },
    {
      x1: x.x5,
      y1: y.y3,
      x2: x.x5,
      y2: y.y4,
      style: styles.fold.mountain,
    },
    { x1: x.x6, y1: y.y3, x2: x.x6, y2: y.y4, style: styles.fold.valley },
    {
      x1: x.x3,
      y1: y.y3,
      x2: x.x3,
      y2: y.y4,
      style: styles.fold.mountain,
      accent: true,
    },
    {
      x1: x.x4,
      y1: y.y3,
      x2: x.x4,
      y2: y.y4,
      style: styles.fold.mountain,
      accent: true,
    },
    {
      x1: flaps.p1.left,
      y1: y.y3,
      x2: flaps.p1.right,
      y2: y.y3,
      style: styles.fold.mountain,
      accent: true,
    },
    {
      x1: flaps.p2.left,
      y1: y.y4,
      x2: flaps.p2.right,
      y2: y.y4,
      style: styles.fold.mountain,
      accent: true,
    },
    {
      x1: x.x3,
      y1: flaps.p3.top,
      x2: x.x3,
      y2: flaps.p3.bottom,
      style: styles.fold.mountain,
      accent: true,
    },
    {
      x1: x.x4,
      y1: flaps.p4.top,
      x2: x.x4,
      y2: flaps.p4.bottom,
      style: styles.fold.mountain,
      accent: true,
    },
  ];

  return lines
    .map(({ x1, y1, x2, y2, style, accent }) => {
      const appliedStyle =
        accent && styles.fold?.accent ? styles.fold.accent : style;
      return createLineElement(x1, y1, x2, y2, appliedStyle);
    })
    .join("\n");
}

function buildCutPath(layout, styles = STYLES) {
  const { x, y, flaps } = layout;
  const commands = [
    `M ${x.x3},${y.y0}`,
    `L ${x.x4},${y.y0}`,
    `L ${x.x4},${y.y1}`,
    `L ${x.x4},${y.y2}`,
    `L ${x.x4},${y.y3}`,
    `L ${flaps.p1.left},${y.y3}`,
    `L ${flaps.p1.left},${flaps.p1.top}`,
    `L ${flaps.p1.right},${flaps.p1.top}`,
    `L ${flaps.p1.right},${y.y3}`,
    `L ${x.x5},${y.y3}`,
    `L ${x.x7},${y.y3}`,
    `L ${x.x7},${y.y4}`,
    `L ${x.x5},${y.y4}`,
    `L ${x.x4},${y.y4}`,
    `L ${x.x4},${flaps.p4.top}`,
    `L ${flaps.p4.right},${flaps.p4.top}`,
    `L ${flaps.p4.right},${flaps.p4.bottom}`,
    `L ${x.x4},${flaps.p4.bottom}`,
    `L ${x.x4},${y.y5}`,
    `L ${x.x4},${y.y7}`,
    `L ${x.x3},${y.y7}`,
    `L ${x.x3},${y.y5}`,
    `L ${x.x3},${y.y4}`,
    `L ${flaps.p2.right},${y.y4}`,
    `L ${flaps.p2.right},${flaps.p2.bottom}`,
    `L ${flaps.p2.left},${flaps.p2.bottom}`,
    `L ${flaps.p2.left},${y.y4}`,
    `L ${x.x2},${y.y4}`,
    `L ${x.x0},${y.y4}`,
    `L ${x.x0},${y.y3}`,
    `L ${x.x2},${y.y3}`,
    `L ${x.x3},${y.y3}`,
    `L ${x.x3},${flaps.p3.bottom}`,
    `L ${flaps.p3.left},${flaps.p3.bottom}`,
    `L ${flaps.p3.left},${flaps.p3.top}`,
    `L ${x.x3},${flaps.p3.top}`,
    `L ${x.x3},${y.y2}`,
    `L ${x.x3},${y.y1}`,
    `L ${x.x3},${y.y0}`,
    "Z",
  ];

  return `<path d="${commands.join(" ")}" style="${styles.cut}" />`;
}

function buildColorPanels(
  layout,
  color,
  {
    bleed = COLOR_SETTINGS.bleed,
    isLid = false,
    inkSave = false,
    boxHeight = 0,
    lidHeight = 0,
    allowance = 0,
  } = {}
) {
  if (!color) {
    return "";
  }

  const { x, y, flaps } = layout;
  const panelStyle = `fill:${color}; fill-opacity:${COLOR_SETTINGS.panelOpacity}; stroke:none;`;
  const flapStyle = `fill:${color}; fill-opacity:${COLOR_SETTINGS.flapOpacity}; stroke:none;`;
  const rects = [];
  const bleedDistance = Math.max(0, bleed);
  const visibleInkSaveHeight = Math.max(
    0,
    boxHeight - lidHeight + bleedDistance
  );

  const panelRects = [
    {
      id: "core",
      x: x.x3,
      y: y.y3,
      width: x.x4 - x.x3,
      height: y.y4 - y.y3,
    },
    {
      id: "top",
      x: x.x3,
      y: y.y2,
      width: x.x4 - x.x3,
      height: y.y3 - y.y2,
    },
    {
      id: "bottom",
      x: x.x3,
      y: y.y4,
      width: x.x4 - x.x3,
      height: y.y5 - y.y4,
    },
    {
      id: "left",
      x: x.x2,
      y: y.y3,
      width: x.x3 - x.x2,
      height: y.y4 - y.y3,
    },
    {
      id: "right",
      x: x.x4,
      y: y.y3,
      width: x.x5 - x.x4,
      height: y.y4 - y.y3,
    },
  ];

  panelRects.forEach(({ id, x: px, y: py, width, height }) => {
    if (!isLid && id === "core") {
      return;
    }

    if (
      !isLid &&
      inkSave &&
      (id === "left" || id === "right" || id === "top" || id === "bottom")
    ) {
      if (id === "left") {
        const colorWidth = Math.min(visibleInkSaveHeight, width);
        if (colorWidth > 0 && height > 0) {
          const colorX = px + width - colorWidth;
          rects.push(
            createRectElement(colorX, py, colorWidth, height, panelStyle)
          );
        }
      } else if (id === "right") {
        const colorWidth = Math.min(visibleInkSaveHeight, width);
        if (colorWidth > 0 && height > 0) {
          rects.push(createRectElement(px, py, colorWidth, height, panelStyle));
        }
      } else if (id === "top") {
        const colorHeight = Math.min(visibleInkSaveHeight, height);
        if (width > 0 && colorHeight > 0) {
          const colorY = py + height - colorHeight;
          rects.push(
            createRectElement(px, colorY, width, colorHeight, panelStyle)
          );
        }
      } else if (id === "bottom") {
        const colorHeight = Math.min(visibleInkSaveHeight, height);
        if (width > 0 && colorHeight > 0) {
          rects.push(createRectElement(px, py, width, colorHeight, panelStyle));
        }
      }
    } else {
      if (width > 0 && height > 0) {
        rects.push(createRectElement(px, py, width, height, panelStyle));
      }
    }
  });

  if (flaps?.p1) {
    const flapWidth = flaps.p1.right - flaps.p1.left;
    const flapHeight = flaps.p1.bottom - flaps.p1.top;
    let stripHeight = Math.min(bleedDistance, flapHeight);
    let stripWidth = flapWidth;
    let stripX = flaps.p1.left;

    if (!isLid && inkSave) {
      stripWidth = Math.min(visibleInkSaveHeight, flapWidth);
      stripX = flaps.p1.left;
    } else {
      stripX = flaps.p1.right - stripWidth;
    }

    if (stripWidth > 0 && stripHeight > 0) {
      rects.push(
        createRectElement(
          stripX,
          flaps.p1.bottom - stripHeight,
          stripWidth,
          stripHeight,
          flapStyle
        )
      );
    }
  }

  if (flaps?.p2) {
    const flapWidth = flaps.p2.right - flaps.p2.left;
    const flapHeight = flaps.p2.bottom - flaps.p2.top;
    let stripHeight = Math.min(bleedDistance, flapHeight);
    let stripWidth = flapWidth;
    let stripX = flaps.p2.left;

    if (!isLid && inkSave) {
      stripWidth = Math.min(visibleInkSaveHeight, flapWidth);
      stripX = flaps.p2.right - stripWidth;
    } else {
      stripX = flaps.p2.left;
    }

    if (stripWidth > 0 && stripHeight > 0) {
      rects.push(
        createRectElement(
          stripX,
          flaps.p2.top,
          stripWidth,
          stripHeight,
          flapStyle
        )
      );
    }
  }

  if (flaps?.p3) {
    const flapWidth = flaps.p3.right - flaps.p3.left;
    const flapHeight = flaps.p3.bottom - flaps.p3.top;
    let stripWidth = Math.min(bleedDistance, flapWidth);
    let stripHeight = flapHeight;

    if (!isLid && inkSave) {
      stripHeight = Math.min(visibleInkSaveHeight, flapHeight);
    }

    if (stripHeight > 0 && stripWidth > 0) {
      rects.push(
        createRectElement(
          flaps.p3.right - stripWidth,
          flaps.p3.bottom - stripHeight,
          stripWidth,
          stripHeight,
          flapStyle
        )
      );
    }
  }

  if (flaps?.p4) {
    const flapWidth = flaps.p4.right - flaps.p4.left;
    const flapHeight = flaps.p4.bottom - flaps.p4.top;
    let stripWidth = Math.min(bleedDistance, flapWidth);
    let stripHeight = flapHeight;

    if (!isLid && inkSave) {
      stripHeight = Math.min(visibleInkSaveHeight, flapHeight);
    }

    if (stripWidth > 0 && stripHeight > 0) {
      rects.push(
        createRectElement(
          flaps.p4.left,
          flaps.p4.top,
          stripWidth,
          stripHeight,
          flapStyle
        )
      );
    }
  }

  return rects.join("\n");
}

function buildLabels(layout, isLid, styles = STYLES, options = {}) {
  const { debugLabels = false } = options;
  const { x, y, flaps } = layout;
  const mid = (start, end) => (start + end) / 2;
  const labels = [];
  const accentPrimary = styles.text.primary;
  const accentMuted = styles.text.muted;
  const staticPrimary = STYLES.text.primary;
  const staticMuted = STYLES.text.muted;

  labels.push({
    x: mid(x.x3, x.x4),
    y: mid(y.y0, y.y1),
    content: "inside",
    style: staticPrimary,
    rotation: 180,
  });

  labels.push({
    x: mid(x.x3, x.x4),
    y: mid(y.y2, y.y3),
    content: isLid ? "back" : "front",
    style: accentPrimary,
    rotation: isLid ? 180 : 0,
  });

  labels.push({
    x: mid(x.x3, x.x4),
    y: mid(y.y3, y.y4),
    content: isLid ? "top" : "bottom",
    style: isLid ? accentPrimary : staticPrimary,
  });

  labels.push({
    x: mid(x.x3, x.x4),
    y: mid(y.y4, y.y5),
    content: isLid ? "front" : "back",
    style: accentPrimary,
    rotation: isLid ? 0 : 180,
  });

  labels.push({
    x: mid(x.x3, x.x4),
    y: mid(y.y6, y.y7),
    content: "tuck",
    style: staticMuted,
    rotation: 180,
  });

  labels.push({
    x: mid(x.x0, x.x1),
    y: mid(y.y3, y.y4),
    content: "tuck",
    style: staticMuted,
    rotation: -90,
  });

  labels.push({
    x: mid(x.x2, x.x3),
    y: mid(y.y3, y.y4),
    content: "left",
    style: accentPrimary,
    rotation: isLid ? 90 : -90,
  });

  labels.push({
    x: mid(x.x4, x.x5),
    y: mid(y.y3, y.y4),
    content: "right",
    style: accentPrimary,
    rotation: isLid ? -90 : 90,
  });

  labels.push({
    x: mid(x.x6, x.x7),
    y: mid(y.y3, y.y4),
    content: "tuck",
    style: staticMuted,
    rotation: 90,
  });

  labels.push({
    x: mid(flaps.p1.left, flaps.p1.right),
    y: mid(flaps.p1.top, flaps.p1.bottom),
    content: "flap",
    style: staticMuted,
    rotation: 90,
  });

  labels.push({
    x: mid(flaps.p2.left, flaps.p2.right),
    y: mid(flaps.p2.top, flaps.p2.bottom),
    content: "flap",
    style: staticMuted,
    rotation: -90,
  });

  labels.push({
    x: mid(flaps.p3.left, flaps.p3.right),
    y: mid(flaps.p3.top, flaps.p3.bottom),
    content: "flap",
    style: staticMuted,
  });

  labels.push({
    x: mid(flaps.p4.left, flaps.p4.right),
    y: mid(flaps.p4.top, flaps.p4.bottom),
    content: "flap",
    style: staticMuted,
    rotation: 180,
  });

  const formattedLabels = labels.map((label, index) => {
    if (!debugLabels) {
      return label;
    }
    const sequenceIndex = index % 26;
    const repeats = Math.floor(index / 26) + 1;
    const letter = String.fromCharCode(65 + sequenceIndex).repeat(repeats);
    return { ...label, content: letter };
  });

  return formattedLabels.map(createTextElement).join("\n");
}

function buildFooterText(layout, isLid, physicalWidth) {
  if (!layout?.x || !layout?.y) {
    return "";
  }

  const { x, y } = layout;
  const footerX = (x.x3 + x.x4) / 2;
  const padding = 2;
  const panelWidth = Number.isFinite(physicalWidth)
    ? Math.max(physicalWidth, 1)
    : Math.max(x.x4 - x.x3, 1);
  const targetWidth = panelWidth * FOOTER_TARGET_WIDTH_RATIO;
  const referenceWidth = footerLogoWidth || FOOTER_VECTOR_WIDTH;
  const referenceHeight = footerLogoHeight || FOOTER_VECTOR_HEIGHT;
  const scale = targetWidth / referenceWidth;
  const scaledHeight = referenceHeight * scale;

  const footerY = isLid ? y.y0 + padding : y.y4 - padding;
  const originX = footerX - targetWidth / 2;
  const originY = footerY - scaledHeight;

  const baseGroup = `
    <g aria-label="${FOOTER_TEXT}" transform="translate(${originX} ${originY}) scale(${scale})" style="${FOOTER_GROUP_STYLE}">
      ${footerLogoMarkup || FOOTER_VECTOR_MARKUP}
    </g>
  `;

  if (isLid) {
    return `<g transform="rotate(180 ${footerX} ${footerY})">${baseGroup}</g>`;
  }
  return baseGroup;
}

function createBoxSVG({
  width,
  height,
  depth,
  allowance,
  insideClearance = 3,
  bleed = COLOR_SETTINGS.bleed,
  isLid = false,
  showLabels = false,
  debugLabels = false,
  color = null,
  inkSave = false,
  boxHeight = 0,
  lidHeight = 0,
}) {
  const layout = computeLayout(
    width,
    height,
    depth,
    allowance,
    insideClearance
  );
  const styles = getStyleConfig({ isLid, color });
  const foldLinesMarkup = buildFoldLines(layout, styles);
  const cutPathMarkup = buildCutPath(layout, styles);
  const layoutPathsMarkup = [foldLinesMarkup, cutPathMarkup]
    .filter(Boolean)
    .join("\n");
  const labelMarkup = showLabels
    ? buildLabels(layout, isLid, styles, { debugLabels })
    : "";
  const footerMarkup = buildFooterText(layout, isLid, width);
  const colorPanels = color
    ? buildColorPanels(layout, color, {
        bleed,
        isLid,
        inkSave,
        boxHeight,
        lidHeight,
        allowance,
      })
    : "";
  const widthMm = layout.viewBox.width;
  const heightMm = layout.viewBox.height;

  return `
          <svg 
              version="1.1"
              width="${widthMm}mm"
              height="${heightMm}mm"
              viewBox="${layout.viewBox.x} ${layout.viewBox.y} ${
    layout.viewBox.width
  } ${layout.viewBox.height}" 
              preserveAspectRatio="xMidYMid meet"
              xmlns="http://www.w3.org/2000/svg"
              data-physical-width-mm="${layout.viewBox.width}"
              data-physical-height-mm="${layout.viewBox.height}"
          >
              <desc>
                  Layout: W=${width}, H=${height}, D=${depth}, Fold clearance=${allowance}
                  Black lines are for cutting.
                  Solid light gray lines are for mountain folds.
                  Dotted light gray lines are for valley folds.
              </desc>
            ${colorPanels ? `<g id="color-panels">${colorPanels}</g>` : ""}
              <g id="layout-paths">
                  ${layoutPathsMarkup}
              </g>
              <g id="labels">
                  ${labelMarkup}
              </g>
                <g id="footer">
                  ${footerMarkup}
                </g>
          </svg>
      `;
}

function downloadSVG(containerId, filename) {
  const container = document.getElementById(containerId);
  if (!container) {
    return;
  }

  const svg = container.querySelector("svg");
  if (!svg) {
    return;
  }

  const svgClone = svg.cloneNode(true);
  svgClone.removeAttribute("style");

  const serializer = new XMLSerializer();
  const svgString = serializer.serializeToString(svgClone);
  const blob = new Blob([svgString], {
    type: "image/svg+xml;charset=utf-8",
  });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  URL.revokeObjectURL(url);
}

const widthInput = document.getElementById("width");
const depthInput = document.getElementById("depth");
const heightInput = document.getElementById("height");
const lidHeightInput = document.getElementById("lidHeight");
const allowanceInput = document.getElementById("allowance");
const bleedInput = document.getElementById("bleed");
const insideClearanceInput = document.getElementById("insideClearance");
const boxColorPicker = document.getElementById("boxColorPicker");
const boxColorText = document.getElementById("boxColorText");
const showLabelsInput = document.getElementById("showLabels");
const inkSaveInput = document.getElementById("inkSave");
const dimensionPresetSelect = document.getElementById("dimensionPreset");
const colorPresetSelect = document.getElementById("colorPreset");
const svgContainerBox = document.getElementById("svg-container-box");
const svgContainerLid = document.getElementById("svg-container-lid");
const MAX_PREVIEW_MM = 200;

function parsePresetNumber(option, key) {
  if (!option?.dataset?.[key]) {
    return null;
  }
  const value = parseFloat(option.dataset[key]);
  return Number.isFinite(value) ? value : null;
}

function extractDimensionPreset(option) {
  if (!option) {
    return null;
  }
  const width = parsePresetNumber(option, "width");
  const depth = parsePresetNumber(option, "depth");
  const height = parsePresetNumber(option, "height");
  const lidHeight = parsePresetNumber(option, "lidHeight");
  if ([width, depth, height, lidHeight].some((value) => value === null)) {
    return null;
  }
  return { width, depth, height, lidHeight };
}

function approxEqual(a, b, tolerance = DIMENSION_MATCH_TOLERANCE) {
  if (!Number.isFinite(a) || !Number.isFinite(b)) {
    return false;
  }
  return Math.abs(a - b) <= tolerance;
}

function syncDimensionPresetSelection() {
  if (!dimensionPresetSelect) {
    return;
  }
  const current = {
    width: parseInputValue(widthInput, NaN),
    depth: parseInputValue(depthInput, NaN),
    height: parseInputValue(heightInput, NaN),
    lidHeight: parseInputValue(lidHeightInput, NaN),
  };
  const matchingOption = Array.from(dimensionPresetSelect.options).find(
    (option) => {
      const preset = extractDimensionPreset(option);
      if (!preset) {
        return false;
      }
      return (
        approxEqual(current.width, preset.width) &&
        approxEqual(current.depth, preset.depth) &&
        approxEqual(current.height, preset.height) &&
        approxEqual(current.lidHeight, preset.lidHeight)
      );
    }
  );
  dimensionPresetSelect.value = matchingOption ? matchingOption.value : "";
  if (window.syncPresetChipStates) {
    window.syncPresetChipStates();
  }
}

function setPresetNumericValue(input, value) {
  if (!input || !Number.isFinite(value)) {
    return;
  }
  const rounded = Math.round(value * DECIMAL_FACTOR) / DECIMAL_FACTOR;
  input.value = rounded.toFixed(DECIMAL_PRECISION);
}

function applyDimensionPreset(option) {
  const preset = extractDimensionPreset(option);
  if (!preset) {
    return;
  }
  setPresetNumericValue(widthInput, preset.width);
  setPresetNumericValue(depthInput, preset.depth);
  setPresetNumericValue(heightInput, preset.height);
  setPresetNumericValue(lidHeightInput, preset.lidHeight);
  syncDimensionPresetSelection();
  scheduleGenerate();
}

function getOptionHex(option) {
  const raw = option?.dataset?.color;
  if (!raw) {
    return null;
  }
  const { hex } = normalizeToHex(raw);
  return hex ? hex.toLowerCase() : null;
}

function getActiveColorHex() {
  const fromText = boxColorText ? normalizeToHex(boxColorText.value) : null;
  if (fromText?.hex) {
    return fromText.hex.toLowerCase();
  }
  const fromPicker = boxColorPicker
    ? normalizeToHex(boxColorPicker.value)
    : null;
  if (fromPicker?.hex) {
    return fromPicker.hex.toLowerCase();
  }
  return null;
}

function syncColorPresetSelection() {
  if (!colorPresetSelect) {
    return;
  }

  if (colorPresetSelect.value === "transparent") {
    if (window.syncPresetChipStates) {
      window.syncPresetChipStates();
    }
    return;
  }

  const activeHex = getActiveColorHex();
  if (!activeHex) {
    if (colorPresetSelect.value !== "") {
      colorPresetSelect.value = "";
    }
    if (window.syncPresetChipStates) {
      window.syncPresetChipStates();
    }
    return;
  }

  const match = Array.from(colorPresetSelect.options).find((option) => {
    const optionHex = getOptionHex(option);
    return optionHex ? optionHex === activeHex : false;
  });
  colorPresetSelect.value = match ? match.value : "";
  if (window.syncPresetChipStates) {
    window.syncPresetChipStates();
  }
}

function applyColorPreset(option) {
  const presetHex = getOptionHex(option);
  if (!presetHex) {
    if (colorPresetSelect.value === "transparent") {
      updateColorInputsState();
      scheduleGenerate();
    }
    return;
  }

  updateColorInputsState();
  if (boxColorPicker) {
    boxColorPicker.value = presetHex;
  }
  if (boxColorText) {
    boxColorText.value = presetHex;
  }
  syncColorPresetSelection();
  scheduleGenerate();
}

function getSelectedOptionLabel(selectEl, fallback) {
  if (!selectEl) {
    return fallback;
  }
  const option = selectEl.selectedOptions?.[0];
  if (!option) {
    return fallback;
  }
  const label = option.textContent?.trim();
  return label || fallback;
}

function describeCustomDimensions() {
  const width = parseInputValue(widthInput, NaN);
  const depth = parseInputValue(depthInput, NaN);
  const height = parseInputValue(heightInput, NaN);
  const lidHeight = parseInputValue(lidHeightInput, NaN);
  if (
    [width, depth, height, lidHeight].some((value) => !Number.isFinite(value))
  ) {
    return "Custom dimensions";
  }
  const format = (value) =>
    (Math.round(value * DECIMAL_FACTOR) / DECIMAL_FACTOR)
      .toFixed(DECIMAL_PRECISION)
      .replace(/\.0$/, "");
  return `${format(width)} x ${format(depth)} x ${format(height)} (lid ${format(
    lidHeight
  )})`;
}

function describeCustomColor() {
  const selectedOption = colorPresetSelect.selectedOptions[0];
  if (selectedOption && selectedOption.value === "transparent") {
    return "Transparent";
  }
  const hex = getActiveColorHex();
  return hex ? hex.toUpperCase() : "Custom color";
}

function sanitizeFilenameSegment(text) {
  if (!text) {
    return "";
  }
  return text
    .replace(/[\\/:*?"<>|]/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

function buildDownloadFilename(type = "box") {
  const dimensionLabel = dimensionPresetSelect?.value
    ? getSelectedOptionLabel(dimensionPresetSelect, "Custom dimensions")
    : describeCustomDimensions();
  const colorLabel = colorPresetSelect?.value
    ? getSelectedOptionLabel(colorPresetSelect, describeCustomColor())
    : describeCustomColor();
  const segments = [dimensionLabel, colorLabel];
  if (type === "lid") {
    segments.push("Lid layout");
  }
  const cleaned = segments
    .map(sanitizeFilenameSegment)
    .filter((segment) => segment.length > 0);
  const fallback = type === "lid" ? "lid-layout" : "box-layout";
  const base = cleaned.length > 0 ? cleaned.join(" - ") : fallback;
  return `${base}.svg`;
}

const debugLabelsEnabled = (() => {
  if (typeof window === "undefined" || typeof window.location === "undefined") {
    return false;
  }
  try {
    const params = new URLSearchParams(window.location.search || "");
    return params.get("debug") === "1";
  } catch (error) {
    return false;
  }
})();

let pendingRenderFrame = null;
function scheduleGenerate() {
  if (pendingRenderFrame !== null) {
    return;
  }
  pendingRenderFrame = window.requestAnimationFrame(() => {
    pendingRenderFrame = null;
    generateBox();
  });
}

function parseInputValue(input, fallback) {
  const parsed = parseFloat(input?.value);
  return Number.isFinite(parsed) ? parsed : fallback;
}

function clampToInputMin(value, input) {
  if (!input) {
    return value;
  }
  const min = parseFloat(input.min);
  if (Number.isFinite(min)) {
    return Math.max(value, min);
  }
  return value;
}

function setNumericInputValue(input, value, fallback = 0) {
  if (!input) {
    return value;
  }
  const resolved = Number.isFinite(value) ? value : fallback;
  const clamped = clampToInputMin(resolved, input);
  const rounded = Math.round(clamped * DECIMAL_FACTOR) / DECIMAL_FACTOR;
  if (document.activeElement !== input) {
    input.value = rounded.toFixed(DECIMAL_PRECISION);
  }
  return rounded;
}

function updateColorInputsState() {
  const isTransparent =
    colorPresetSelect && colorPresetSelect.value === "transparent";
  const isCustom = colorPresetSelect && colorPresetSelect.value === "";
  const shouldDisable = isTransparent;

  if (boxColorPicker) {
    boxColorPicker.disabled = shouldDisable;
  }
  if (boxColorText) {
    boxColorText.disabled = shouldDisable;
  }
  if (inkSaveInput) {
    inkSaveInput.disabled = shouldDisable;
  }

  if (isCustom) {
    if (boxColorPicker) {
      boxColorPicker.disabled = false;
    }
    if (boxColorText) {
      boxColorText.disabled = false;
    }
    if (inkSaveInput) {
      inkSaveInput.disabled = false;
    }
  }
}

function resolveSelectedColor() {
  const isTransparent =
    colorPresetSelect && colorPresetSelect.value === "transparent";
  if (isTransparent) {
    return null;
  }

  const manualValue = normalizeColorValue(boxColorText?.value);
  if (manualValue) {
    return manualValue;
  }
  const pickerValue = normalizeColorValue(boxColorPicker?.value);
  if (pickerValue) {
    return pickerValue;
  }
  return null;
}

function syncLinkedDimensions() {
  const allowance = parseInputValue(allowanceInput, 1);
  setNumericInputValue(allowanceInput, allowance, 1);
  const baseWidth = parseInputValue(widthInput, 61);
  setNumericInputValue(widthInput, baseWidth, 61);

  const baseDepth = parseInputValue(depthInput, 46);
  setNumericInputValue(depthInput, baseDepth, 46);

  return {
    lidWidth: baseWidth + allowance + LID_FIT_EXTRA,
    lidDepth: baseDepth + allowance + LID_FIT_EXTRA,
  };
}

function generateBox() {
  const { lidWidth, lidDepth } = syncLinkedDimensions();

  const allowance = parseInputValue(allowanceInput, 1);
  const bleedValue = parseInputValue(bleedInput, COLOR_SETTINGS.bleed);
  setNumericInputValue(bleedInput, bleedValue, COLOR_SETTINGS.bleed);
  const insideClearance = parseInputValue(insideClearanceInput, 3);
  setNumericInputValue(insideClearanceInput, insideClearance, 3);
  const W = parseInputValue(widthInput, 61);
  const H = parseInputValue(heightInput, 25);
  setNumericInputValue(heightInput, H, 25);
  const D = parseInputValue(depthInput, 46);
  const lidHeight = parseInputValue(lidHeightInput, 20);
  setNumericInputValue(lidHeightInput, lidHeight, 20);
  const showLabels = Boolean(showLabelsInput?.checked);
  const debugLabels = debugLabelsEnabled;
  const inkSave = Boolean(inkSaveInput?.checked);
  const appliedColor = resolveSelectedColor();

  const boxSvgContent = createBoxSVG({
    width: W,
    height: H,
    depth: D,
    allowance,
    insideClearance,
    bleed: bleedValue,
    isLid: false,
    showLabels,
    debugLabels,
    color: appliedColor,
    inkSave,
    boxHeight: H,
    lidHeight,
  });
  svgContainerBox.innerHTML = boxSvgContent;
  const boxSvg = svgContainerBox.querySelector("svg");
  sizeSvgPreview(boxSvg);

  const lidSvgContent = createBoxSVG({
    width: lidWidth,
    height: lidHeight,
    depth: lidDepth,
    allowance,
    insideClearance,
    bleed: bleedValue,
    isLid: true,
    showLabels,
    debugLabels,
    color: appliedColor,
    inkSave: false,
    boxHeight: lidHeight,
    lidHeight,
  });
  svgContainerLid.innerHTML = lidSvgContent;
  const lidSvg = svgContainerLid.querySelector("svg");
  sizeSvgPreview(lidSvg);
  syncDimensionPresetSelection();
  syncColorPresetSelection();
}

function sizeSvgPreview(svgEl) {
  if (!svgEl) {
    return;
  }
  const widthMm = parseFloat(
    svgEl.getAttribute("data-physical-width-mm") || "0"
  );
  const heightMm = parseFloat(
    svgEl.getAttribute("data-physical-height-mm") || "0"
  );
  if (!(widthMm && heightMm)) {
    return;
  }
  const largestMm = Math.max(widthMm, heightMm);
  const scale = largestMm > MAX_PREVIEW_MM ? MAX_PREVIEW_MM / largestMm : 1;
  svgEl.style.width = `${widthMm * MM_TO_PX * scale}px`;
  svgEl.style.height = `${heightMm * MM_TO_PX * scale}px`;
}

const numericInputs = [
  widthInput,
  depthInput,
  heightInput,
  lidHeightInput,
  allowanceInput,
  bleedInput,
  insideClearanceInput,
];

numericInputs.forEach((input) => {
  input?.addEventListener("input", () => {
    if (
      dimensionPresetSelect &&
      (input === widthInput ||
        input === depthInput ||
        input === heightInput ||
        input === lidHeightInput)
    ) {
      dimensionPresetSelect.value = "";
    }
    scheduleGenerate();
  });
});

boxColorPicker?.addEventListener("input", () => {
  if (boxColorText) {
    boxColorText.value = boxColorPicker.value;
  }
  syncColorPresetSelection();
  scheduleGenerate();
});

boxColorText?.addEventListener("input", () => {
  const { hex } = normalizeToHex(boxColorText.value);
  if (hex && boxColorPicker) {
    boxColorPicker.value = hex;
  }
  syncColorPresetSelection();
  scheduleGenerate();
});

boxColorText?.addEventListener("blur", () => {
  const { hex } = normalizeToHex(boxColorText?.value);
  if (hex) {
    if (boxColorText) {
      boxColorText.value = hex;
    }
    if (boxColorPicker) {
      boxColorPicker.value = hex;
    }
  }
  syncColorPresetSelection();
});

dimensionPresetSelect?.addEventListener("change", () => {
  const option = dimensionPresetSelect.selectedOptions[0];
  if (option && option.dataset.width) {
    applyDimensionPreset(option);
  } else {
    scheduleGenerate();
  }
});

colorPresetSelect?.addEventListener("change", () => {
  const option = colorPresetSelect.selectedOptions[0];
  if (option) {
    if (option.value === "transparent") {
      updateColorInputsState();
      scheduleGenerate();
    } else if (option.dataset.color) {
      applyColorPreset(option);
    } else {
      // Custom color
      updateColorInputsState();
      scheduleGenerate();
    }
  }
});

showLabelsInput?.addEventListener("change", scheduleGenerate);

inkSaveInput?.addEventListener("change", scheduleGenerate);

// Preset chip interactions
function initPresetChips() {
  const dimensionChips = document.querySelectorAll(
    "#dimensionChips .preset-chip"
  );
  const colorChips = document.querySelectorAll("#colorChips .preset-chip");

  // Sync chip active states with dropdown selections
  function syncChipStates() {
    dimensionChips.forEach((chip) => {
      const presetValue = chip.dataset.preset;
      chip.classList.toggle(
        "active",
        dimensionPresetSelect?.value === presetValue
      );
    });

    colorChips.forEach((chip) => {
      const presetValue = chip.dataset.preset;
      chip.classList.toggle("active", colorPresetSelect?.value === presetValue);
    });
  }

  // Expose globally for sync functions
  window.syncPresetChipStates = syncChipStates;

  // Handle dimension chip clicks
  dimensionChips.forEach((chip) => {
    chip.addEventListener("click", () => {
      const presetValue = chip.dataset.preset;
      if (dimensionPresetSelect) {
        dimensionPresetSelect.value = presetValue;
        dimensionPresetSelect.dispatchEvent(new Event("change"));
      }
      syncChipStates();
    });
  });

  // Handle color chip clicks
  colorChips.forEach((chip) => {
    chip.addEventListener("click", () => {
      const presetValue = chip.dataset.preset;
      if (colorPresetSelect) {
        colorPresetSelect.value = presetValue;
        colorPresetSelect.dispatchEvent(new Event("change"));
      }
      syncChipStates();
    });
  });

  // Sync on dropdown changes
  dimensionPresetSelect?.addEventListener("change", syncChipStates);
  colorPresetSelect?.addEventListener("change", syncChipStates);

  // Initial sync
  syncChipStates();
}

async function loadPresets() {
  let data = null;

  if (typeof fetch === "function") {
    try {
      const response = await fetch("presets.json", { cache: "no-store" });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      data = await response.json();
    } catch (error) {
      console.error("Error fetching presets.json:", error);
    }
  }

  if (!data) {
    try {
      const presetScript = document.getElementById("presets-data");
      if (presetScript?.textContent) {
        data = JSON.parse(presetScript.textContent);
      }
    } catch (error) {
      console.error("Error parsing inline presets:", error);
    }
  }

  DIMENSION_PRESETS = data?.dimensions || [];
  COLOR_PRESETS = data?.colors || [];
}

async function loadFooterLogo() {
  if (typeof fetch !== "function") {
    return;
  }

  try {
    const response = await fetch(FOOTER_LOGO_PATH, { cache: "no-store" });
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const svgText = await response.text();
    const svgMatch = svgText.match(/<svg\b[^>]*>([\s\S]*?)<\/svg>/i);
    if (!svgMatch) {
      footerLogoMarkup = svgText.trim();
      return;
    }

    footerLogoMarkup = svgMatch[1].trim() || FOOTER_VECTOR_MARKUP;

    const svgTag = svgMatch[0];
    const viewBoxMatch = svgTag.match(/viewBox=["']([^"']+)["']/i);
    if (viewBoxMatch) {
      const viewBoxParts = viewBoxMatch[1]
        .trim()
        .split(/[\s,]+/)
        .map((value) => Number(value));
      if (
        viewBoxParts.length === 4 &&
        Number.isFinite(viewBoxParts[2]) &&
        Number.isFinite(viewBoxParts[3]) &&
        viewBoxParts[2] > 0 &&
        viewBoxParts[3] > 0
      ) {
        footerLogoWidth = viewBoxParts[2];
        footerLogoHeight = viewBoxParts[3];
        return;
      }
    }

    const widthMatch = svgTag.match(/width=["']([\d.]+)["']/i);
    const heightMatch = svgTag.match(/height=["']([\d.]+)["']/i);
    const parsedWidth = widthMatch ? Number(widthMatch[1]) : null;
    const parsedHeight = heightMatch ? Number(heightMatch[1]) : null;
    if (
      Number.isFinite(parsedWidth) &&
      Number.isFinite(parsedHeight) &&
      parsedWidth > 0 &&
      parsedHeight > 0
    ) {
      footerLogoWidth = parsedWidth;
      footerLogoHeight = parsedHeight;
    }
  } catch (error) {
    console.error("Error loading footer logo:", error);
  }
}

function populatePresetDropdowns() {
  // Populate dimension presets
  if (dimensionPresetSelect) {
    dimensionPresetSelect.innerHTML =
      '<option value="">Custom dimensions</option>';
    DIMENSION_PRESETS.forEach((preset) => {
      const option = document.createElement("option");
      option.value = preset.id;
      option.textContent = preset.name;
      option.dataset.width = preset.width;
      option.dataset.depth = preset.depth;
      option.dataset.height = preset.height;
      option.dataset.lidHeight = preset.lidHeight;
      dimensionPresetSelect.appendChild(option);
    });
  }

  // Populate color presets
  if (colorPresetSelect) {
    colorPresetSelect.innerHTML =
      '<option value="transparent">Transparent</option><option value="">Custom color</option>';
    COLOR_PRESETS.forEach((preset) => {
      const option = document.createElement("option");
      option.value = preset.id;
      option.textContent = preset.name;
      option.dataset.color = preset.color;
      colorPresetSelect.appendChild(option);
    });
  }
}

function initAdvancedToggle() {
  const advancedSection = document.querySelector(".advanced-section");
  const toggleButton = document.querySelector(".advanced-toggle");
  const advancedContent = document.getElementById("advancedFields");

  if (!advancedSection || !toggleButton || !advancedContent) {
    return;
  }

  const setState = (expanded) => {
    toggleButton.setAttribute("aria-expanded", expanded ? "true" : "false");
    advancedSection.classList.toggle("is-collapsed", !expanded);
    toggleButton.textContent = expanded ? "Hide" : "Show";
  };

  toggleButton.addEventListener("click", () => {
    const expanded = toggleButton.getAttribute("aria-expanded") === "true";
    setState(!expanded);
  });

  setState(false);
}

function initDonateAvatarSwap() {
  const donateButton = document.querySelector(".donate-button");
  const donateAvatar = document.querySelector(".donate-avatar");

  if (!donateButton || !donateAvatar) {
    return;
  }

  const heartSrc = "me_hearts.png";

  donateButton.addEventListener("click", () => {
    if (donateAvatar.getAttribute("src") !== heartSrc) {
      donateAvatar.setAttribute("src", heartSrc);
    }
  });
}

window.addEventListener("load", async () => {
  await Promise.all([loadPresets(), loadFooterLogo()]);
  populatePresetDropdowns();

  if (colorPresetSelect) {
    colorPresetSelect.value = "transparent";
  }

  syncLinkedDimensions();
  updateColorInputsState();
  if (boxColorPicker && boxColorText && !boxColorText.value) {
    boxColorText.value = boxColorPicker.value;
  }
  initPresetChips();
  initAdvancedToggle();
  initDonateAvatarSwap();
  generateBox();
});
